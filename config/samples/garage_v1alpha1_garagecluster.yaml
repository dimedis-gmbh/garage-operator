apiVersion: garage.dimedis.io/v1alpha1
kind: GarageCluster
metadata:
  labels:
    app.kubernetes.io/name: garagecluster
    app.kubernetes.io/instance: garagecluster-sample
    app.kubernetes.io/part-of: garage-operator
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/created-by: garage-operator
  name: garagecluster-sample
spec:
  # Number of Garage pod replicas in the StatefulSet
  replicaCount: 4

  # Replication factor: number of copies of data stored in the cluster (minimum 1, typically 3)
  # See https://garagehq.deuxfleurs.fr/documentation/reference-manual/configuration/#replication_factor
  replicationFactor: 2

  # Consistency mode for read/write operations
  # - consistent: full consistency (n out of n nodes must respond)
  # - degraded: degraded consistency (n/2 + 1 out of n nodes must respond)
  # - dangerous: no consistency check (1 out of n nodes must respond)
  # See https://garagehq.deuxfleurs.fr/documentation/reference-manual/configuration/#consistency_mode
  consistencyMode: "consistent"

  # Block size for Garage data blocks
  # See https://garagehq.deuxfleurs.fr/documentation/reference-manual/configuration/#block_size
  blockSize: "1Mi"

  # Persistence configuration
  persistence:
    data:
      size: "20Gi"
      # storageClass: "fast-ssd"
    meta:
      size: "1Gi"
      # storageClass: "fast-ssd"

  # Optional: Layout configuration
  # Default mode is zonePerNode, which assigns each replica to its own zone (z1, z2, z3, ...)
  # Uncomment to use node labels for zone assignment:
  # layout:
  #   mode: zoneFromNodeLabel
  #   zoneNodeLabel: "topology.kubernetes.io/zone"

  # Optional: S3 API configuration
  s3Api:
    enabled: true
    region: "garage"
    rootDomain: ".s3.garage.localhost"

  # Optional: Resource limits
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

  # Ingress configuration
  ingress:
    enabled: true
    className: "nginx"
    host: "garage.127-0-0-4.nip.io"
    tls:
      enabled: true
      secretName: "garage-tls"
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      kubernetes.io/tls-acme: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "0"
